<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Drag-and-Drop Composer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* RESET */
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{background:#222;color:#f0f0f0;font-family:"Segoe UI",Tahoma,Verdana,sans-serif;display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:16px;gap:12px}
    h1{font-size:clamp(1.2rem,4vw,2rem);text-align:center}

    /* STAGE */
    #stage{width:min(800px,92vw);aspect-ratio:2/1;background:url('./resources/stage_bg.png') center/cover;border:4px solid #5c0000;border-bottom:24px solid #5c0000;box-shadow:0 0 12px #0008;position:relative;display:flex;align-items:center;justify-content:center;color:#fffc;font-size:1.1rem;overflow:hidden;touch-action:none;border-radius:6px}

    /* PALETTE */
    #palette{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
    .inst{width:56px;height:56px;border-radius:50%;background:#444;display:grid;place-items:center;font-size:2rem;cursor:pointer;user-select:none;touch-action:none;transition:.15s}
    .inst:active{transform:scale(.9);box-shadow:0 0 6px #000a}
    .inst.guitar{background:#6b4f4b}.inst.drum{background:#4b6b4f}.inst.violin{background:#4b4b6b}.inst.keyboard{background:#6b6b4b}

    /* SELECTED LIST */
    #selected{width:min(800px,92vw)}
    #selected h3{font-size:clamp(1rem,3.4vw,1.3rem);margin-bottom:6px;border-bottom:2px solid #555}
    #sel-list{display:flex;flex-direction:column;gap:6px}
    .row{display:flex;align-items:center;background:#333;border-radius:4px;padding:6px 10px;gap:6px}
    .row span.name{flex:1;font-size:.95rem}
    .row input{flex:2}
    .row button{background:#a00;color:#fff;border:none;border-radius:4px;padding:4px 6px;font-size:.8rem;cursor:pointer}

    /* BUTTONS */
    .btn{background:#28a745;color:#fff;border:none;border-radius:5px;padding:10px 20px;font-size:.9rem;cursor:pointer}
    .btn:hover{background:#3fc35b}.danger{background:#dc3545}.danger:hover{background:#e85c5c}

    /* ICONS ON STAGE */
    .icon{position:absolute;width:56px;height:56px;border-radius:50%;display:grid;place-items:center;font-size:2rem;cursor:pointer;touch-action:none;user-select:none}
    .icon.playing{box-shadow:0 0 10px 3px #fff8;filter:brightness(1.3)}

    /* FLOAT NOTES */
    @keyframes float{0%{transform:translateY(0);opacity:1}100%{transform:translateY(-36px);opacity:0}}
    .note{position:absolute;font-size:1.1rem;animation:float 1.1s ease-out forwards;pointer-events:none}

    /* GHOST DURING DRAG */
    .ghost{position:fixed;width:56px;height:56px;font-size:2rem;pointer-events:none;opacity:.85;transform:translate(-50%,-50%);z-index:9999}

    /* SMALL-SCREEN PORTRAIT TWEAKS */
    @media (max-width:600px){
      #stage{aspect-ratio:1.6/1;border-width:3px;border-bottom-width:18px}
      .inst,.icon{width:48px;height:48px;font-size:1.7rem}
      .ghost{width:48px;height:48px;font-size:1.7rem}
      .row span.name{font-size:.85rem}
    }

    #controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    #controls label {
      font-size: 1rem;
      color: #fffc;
    }
    #piano-select {
      background: #444;
      color: #f0f0f0;
      border: 2px solid #555;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 1rem;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    #piano-select:hover,
    #piano-select:focus {
      border-color: #28a745;
      background: #555;
      outline: none;
    }
  </style>
</head>
<body>
  <h1>Classical Stage Composer</h1>
  <div id="stage"><p>Drag or Tap instruments</p></div>
  <div id="palette"></div>
  <div id="selected"><h3>Selected Accompaniments</h3><div id="sel-list"></div></div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
    <button id="play" class="btn">Finish & Play</button>
    <button id="clear" class="btn danger">Reset</button>
    <button id="ref" class="btn">‚ñ∂Ô∏è Reference</button>
  </div>
  <div id="controls">
    <label for="piano-select">Select Piano:</label>
    <select id="piano-select">
      <option value="1">Piano 1</option>
      <option value="2">Piano 2</option>
      <option value="3">Piano 3</option>
    </select>
  </div>
<script>
const base_path="./resources"; // Base path for audio files

/***** Build palette & basic constants *****/
const palette=document.getElementById('palette');const stage=document.getElementById('stage');const list=document.getElementById('sel-list');const playBtn=document.getElementById('play');const clearBtn=document.getElementById('clear');const refBtn=document.getElementById('ref');
const emojis={guitar:'üé∏',bass:'üé∏',violin:'üéª',cello:'üéª',flute:'ü™à',saxophone:'üé∑',drum:'ü•Å'};const selected={};const timers={};let playing=false,start=0,dragCtx=null;
['guitar','bass','violin','cello','flute','saxophone','drum'].forEach(n => {
  const d = document.createElement('div');
  d.className = `inst ${n}`;
  d.dataset.ins = n;

  // Emoji label
  const emojiSpan = document.createElement('div');
  emojiSpan.textContent = emojis[n];
  emojiSpan.style.fontSize = '2rem'; // adjust size as needed
  d.appendChild(emojiSpan);

  // Text description
  const label = document.createElement('div');
  label.textContent = n.charAt(0).toUpperCase() + n.slice(1); // Capitalized instrument name
  label.style.fontSize = '0.8rem';
  label.style.marginTop = '4px';
  label.style.textAlign = 'center';
  d.appendChild(label);

  palette.appendChild(d);
  addPointer(d, 'palette');
});
/***** Piano main *****/
let currentPiano = 1;
let piano;
const pianoSelect = document.getElementById('piano-select');

function loadPiano(i) {
  // Pause and replace previous piano (if any)
  if (piano) {
    piano.pause();
  }
  piano = new Audio(`${base_path}/piano${i}.wav`);
  piano._on = true;
  selected.piano = piano;
}

// Initial load
loadPiano(currentPiano);

// When dropdown changes, reload piano and reference audio
pianoSelect.addEventListener('change', (e) => {
  currentPiano = e.target.value;
  loadPiano(currentPiano);
  refAud.src = `${base_path}/input${currentPiano}.wav`;
});
/***** Pointer-events drag engine *****/
function addPointer(el,origin){el.addEventListener('pointerdown',e=>{e.preventDefault();const name=(origin==='palette')?el.dataset.ins:el.dataset.instrument;dragCtx={name,origin,ghost:makeGhost(name)};moveGhost(e);window.addEventListener('pointermove',moveGhost);window.addEventListener('pointerup',endDrag,{once:true});});}
function makeGhost(name){const g=document.createElement('div');g.className='ghost';g.textContent=emojis[name];document.body.appendChild(g);return g}
function moveGhost(e){if(!dragCtx)return;dragCtx.ghost.style.left=e.clientX+'px';dragCtx.ghost.style.top=e.clientY+'px';}
function endDrag(e){window.removeEventListener('pointermove',moveGhost);const {name,origin,ghost}=dragCtx;ghost.remove();const inside=inStage(e.clientX,e.clientY);
  if(origin==='palette'&&inside)addTrack(name,e.clientX,e.clientY);
  else if(origin==='stage'){const ic=document.querySelector(`.icon[data-instrument="${name}"]`);if(ic){if(inside){posIcon(ic,e.clientX,e.clientY);}else removeTrack(name);}}
  dragCtx=null;}
function inStage(x,y){const r=stage.getBoundingClientRect();return x>r.left&&x<r.right&&y>r.top&&y<r.bottom}
/***** Track CRUD *****/
function addTrack(name, x, y) {
  if (!selected[name]) {
    const a = new Audio(`${base_path}/${name}${currentPiano}.wav`);
    a.volume = 0.5;
    a._on = true;
    selected[name] = a;
    addRow(name, a);
  } else if (!selected[name]._on) {
    selected[name]._on = true;
    selected[name].muted = false;
    addRow(name, selected[name]);
  }
  createIcon(name, x, y);
  if (playing) play(name);
}
function createIcon(name,x,y){let ic=document.querySelector(`.icon[data-instrument="${name}"]`);if(!ic){ic=document.createElement('div');ic.className='icon';ic.dataset.instrument=name;ic.textContent=emojis[name];stage.appendChild(ic);addPointer(ic,'stage');}
  posIcon(ic,x,y);} 
function posIcon(ic,x,y){const r=stage.getBoundingClientRect();ic.style.left=(x-r.left-28)+'px';ic.style.top=(y-r.top-28)+'px';}
function addRow(name,a){const row=document.createElement('div');row.className='row';row.innerHTML=`<span class='name'>${name[0].toUpperCase()+name.slice(1)}</span>`;
  const sld=document.createElement('input');sld.type='range';sld.min=0;sld.max=1;sld.step=.01;sld.value=a.volume;sld.oninput=()=>a.volume=parseFloat(sld.value);
  const rm=document.createElement('button');rm.textContent='Remove';rm.onclick=()=>removeTrack(name,row);
  row.append(sld,rm);list.appendChild(row);} 
function removeTrack(name,row){const a=selected[name];if(!a)return;a.pause();a._on=false;a.muted=true;if(row)row.remove();document.querySelectorAll(`.icon[data-instrument="${name}"]`).forEach(el=>el.remove());clearInterval(timers[name]);delete timers[name];}
/***** Playback *****/
function play(name){const a=selected[name];if(!a||!a._on)return;const t=(Date.now()-start)/1000;const begin=()=>{try{a.currentTime=t}catch{}a.play().catch(()=>{});const icon=document.querySelector(`.icon[data-instrument="${name}"]`);if(icon){icon.classList.add('playing');if(!timers[name])timers[name]=setInterval(()=>note(icon),600);}a.onended=()=>{icon?.classList.remove('playing');clearInterval(timers[name]);delete timers[name];};};
  if(a.readyState<1){a.addEventListener('loadedmetadata',begin,{once:true});a.preload='auto'}else begin();}
function note(icon){const n=document.createElement('div');n.className='note';n.textContent=Math.random()>.5?'üéµ':'üé∂';n.style.left=(icon.offsetLeft+18)+'px';n.style.top=(icon.offsetTop-6)+'px';stage.appendChild(n);setTimeout(()=>n.remove(),1100);}
function stopAll(){playing=false;playBtn.textContent='Finish & Play';for(const k in selected){selected[k].pause();selected[k].currentTime=0}for(const k in timers){clearInterval(timers[k]);delete timers[k];}document.querySelectorAll('.playing').forEach(el=>el.classList.remove('playing'));}
/***** Buttons *****/
playBtn.onclick=()=>{if(playing){stopAll();return;}playing=true;playBtn.textContent='Stop';start=Date.now();piano.currentTime=0;piano.play();for(const k in selected){if(k!=='piano')play(k)}};
clearBtn.onclick = () => {
  stopAll();
  // Reset piano selection to default (1)
  pianoSelect.value = "1";
  currentPiano = 1;
  loadPiano(currentPiano);
  // Reset reference audio to default
  refAud.src = `${base_path}/input${currentPiano}.wav`;
  // Clear accompaniments
  for (const k in selected) {
    if (k !== 'piano') delete selected[k];
  }
  document.querySelectorAll('.icon').forEach(el => el.remove());
  list.innerHTML = '';
};
/***** Reference audio *****/
const refAud = new Audio(`${base_path}/input${currentPiano}.wav`);let refOn=false;refBtn.onclick=()=>{if(refOn){refAud.pause();refBtn.textContent='‚ñ∂Ô∏è Reference';refOn=false}else{refAud.currentTime=0;refAud.play();refBtn.textContent='‚è∏ Reference';refOn=true}};refAud.onended=()=>{refBtn.textContent='‚ñ∂Ô∏è Reference';refOn=false};
</script>
</body>
</html>