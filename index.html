<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Drag‚Äëand‚ÄëDrop Music Composer ‚Äì Pointer‚ÄëDriven</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <style>
    /* Reset */
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{background:#222;color:#f0f0f0;font-family:"Segoe UI",Tahoma,Verdana,sans-serif;display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:20px}
    h1{margin-bottom:10px;font-size:2rem;letter-spacing:1px;text-align:center}
    /* Stage */
    #stage{width:800px;height:400px;background:url('stage_bg.png') center/cover;border:5px solid #5c0000;border-bottom:30px solid #5c0000;box-shadow:0 0 15px rgba(0,0,0,.7);position:relative;margin:20px 0;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.6);font-size:1.2rem;overflow:hidden;touch-action:none}
    #stage.highlight{outline:4px dashed #ffd700}
    /* Instrument panel */
    #instrument-panel{display:flex;gap:20px;margin-bottom:20px;touch-action:none}
    .instrument{width:60px;height:60px;border-radius:50%;background:#444;display:flex;align-items:center;justify-content:center;cursor:grab;font-size:2rem;transition:.15s}
    .instrument.guitar{background:#6b4f4b}
    .instrument.drum{background:#4b6b4f}
    .instrument.violin{background:#4b4b6b}
    .instrument.keyboard{background:#6b6b4b}
    /* Selected list */
    #selected{width:800px;max-width:100%;margin-bottom:20px}
    #selected h3{margin-bottom:8px;font-size:1.2rem;border-bottom:2px solid #555}
    #selected-list{display:flex;flex-direction:column;gap:8px}
    .selected-item{display:flex;align-items:center;justify-content:space-between;background:#333;padding:8px 12px;border-radius:5px}
    .selected-item span{flex:1;font-size:1rem}
    .selected-item input{flex:2;margin:0 10px}
    .selected-item button{background:#a00;color:#fff;border:none;border-radius:4px;padding:4px 8px;cursor:pointer}
    /* Buttons */
    button.action{background:#28a745;color:#fff;border:none;border-radius:5px;padding:12px 24px;font-size:1rem;cursor:pointer;margin-bottom:20px}
    button.action:hover{background:#3fc35b}
    button.danger{background:#dc3545}
    /* Audio & icons */
    audio{display:none}
    .in-stage{position:absolute;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem;cursor:grab;z-index:10;touch-action:none}
    .in-stage.playing{box-shadow:0 0 12px 4px rgba(255,255,255,.7);filter:brightness(1.3)}
    /* Note animation */
    @keyframes float{0%{transform:translateY(0);opacity:1}100%{transform:translateY(-40px);opacity:0}}
    .note{position:absolute;font-size:1.2rem;pointer-events:none;animation:float 1.2s ease-out forwards;z-index:20}
    /* Ghost */
    .ghost{position:fixed;width:60px;height:60px;font-size:2rem;pointer-events:none;opacity:.8;transform:translate(-50%, -50%)}
    /* Portrait overlay */
    #tip{position:fixed;inset:0;background:#000c;color:#fff;display:none;align-items:center;justify-content:center;z-index:9999;font-size:1.6rem;text-align:center;padding:20px}
    /* Mobile landscape tweaks */
    @media(max-width:900px) and (orientation:landscape){#stage,#selected{width:96vw}#stage{height:min(60vw,40vh)}#instrument-panel{flex-wrap:wrap;gap:10px}h1{font-size:1.3rem}}
  </style>
</head>
<body>
  <div id="tip">ËØ∑Ê®™Â±è‰ΩøÁî®Êú¨Á®ãÂ∫è ‚Üª</div>
  <h1>Classical Stage Composer</h1>
  <div id="stage"><p>Drag instruments here</p></div>
  <div id="instrument-panel"></div>
  <div id="selected"><h3>Selected:</h3><div id="selected-list"></div></div>
  <button id="finish" class="action">Finish &amp; Play</button>
  <button id="reset" class="action danger">Reset</button>
  <button id="ref" class="action">‚ñ∂Ô∏è Reference</button>

<script>
/***** Orientation tip *****/
function check(){document.getElementById('tip').style.display=(window.innerHeight>window.innerWidth)?'flex':'none'}
window.addEventListener('load',check);window.addEventListener('resize',check);window.addEventListener('orientationchange',check);

/***** State *****/
const stage=document.getElementById('stage');const panel=document.getElementById('instrument-panel');const fin=document.getElementById('finish');const reset=document.getElementById('reset');const refBtn=document.getElementById('ref');const list=document.getElementById('selected-list');
const emoji={guitar:'üé∏',drum:'ü•Å',violin:'üéª',keyboard:'üéπ'};const selected={};const timers={};let playing=false,startTime=0;let dragData=null;
const piano=new Audio('piano.wav');piano._active=true;selected.piano=piano;

/***** Build palette *****/
['guitar','drum','violin','keyboard'].forEach(n=>{const d=document.createElement('div');d.className=`instrument ${n}`;d.textContent=emoji[n];d.dataset.ins=n;panel.appendChild(d);addPointer(d,'palette');});

/***** Pointer‚Äëbased drag *****/
function addPointer(el,origin){el.addEventListener('pointerdown',e=>{e.preventDefault();const name=el.dataset.ins||el.dataset.instrument;dragData={name,origin,ghost:createGhost(name),offsetX:e.clientX,offsetY:e.clientY};moveGhost(e);window.addEventListener('pointermove',moveGhost);window.addEventListener('pointerup',endDrag,{once:true});});}
function createGhost(name){const g=document.createElement('div');g.className='ghost';g.textContent=emoji[name];document.body.appendChild(g);return g}
function moveGhost(e){if(!dragData)return;dragData.ghost.style.left=e.clientX+'px';dragData.ghost.style.top=e.clientY+'px';}
function endDrag(e){window.removeEventListener('pointermove',moveGhost);const {name,origin,ghost}=dragData;ghost.remove();const inside=isInsideStage(e.clientX,e.clientY);
  if(origin==='palette'&&inside){addInstrument(name,e.clientX,e.clientY)}
  if(origin==='stage'){const icon=document.querySelector(`.in-stage[data-instrument="${name}"]`);if(icon){icon.style.left=(e.clientX-stage.getBoundingClientRect().left-30)+'px';icon.style.top=(e.clientY-stage.getBoundingClientRect().top-30)+'px';if(!inside){removeInstrument(name)}}}
  dragData=null;}
function isInsideStage(x,y){const r=stage.getBoundingClientRect();return x>r.left&&x<r.right&&y>r.top&&y<r.bottom}

/***** Instrument ops *****/
function addInstrument(name,x,y){if(!selected[name]){const a=new Audio(name+'.wav');a.volume=.5;a.loop=false;a._active=true;selected[name]=a;addRow(name,a);}else if(!selected[name]._active){selected[name]._active=true;selected[name].muted=false;addRow(name,selected[name]);}
  createIcon(name,x,y);if(playing)play(name);} 
function createIcon(name,x,y){let icon=document.querySelector(`.in-stage[data-instrument="${name}"]`);if(!icon){icon=document.createElement('div');icon.className='in-stage';icon.dataset.instrument=name;icon.textContent=emoji[name];stage.appendChild(icon);addPointer(icon,'stage');}
  const r=stage.getBoundingClientRect();icon.style.left=(x-r.left-30)+'px';icon.style.top=(y-r.top-30)+'px';}
function addRow(name,a){const row=document.createElement('div');row.className='selected-item';const lab=document.createElement('span');lab.textContent=name.charAt(0).toUpperCase()+name.slice(1);const sld=document.createElement('input');sld.type='range';sld.min=0;sld.max=1;sld.step=.01;sld.value=a.volume;sld.oninput=()=>{a.volume=parseFloat(sld.value)};const rm=document.createElement('button');rm.textContent='Remove';rm.onclick=()=>removeInstrument(name,row);row.append(lab,sld,rm);list.appendChild(row);} 
function removeInstrument(name,row){const a=selected[name];if(!a)return;a.pause();a._active=false;a.muted=true;if(row)row.remove();document.querySelectorAll(`.in-stage[data-instrument="${name}"]`).forEach(el=>el.remove());clearInterval(timers[name]);delete timers[name];}
function play(name){const a=selected[name];if(!a||!a._active)return;const start=()=>{const t=(Date.now()-startTime)/1000;if(!isFinite(a.duration)||t<a.duration){try{a.currentTime=t}catch{}a.play().catch(()=>{});const icon=document.querySelector(`.in-stage[data-instrument="${name}"]`);if(icon){icon.classList.add('playing');if(!timers[name])timers[name]=setInterval(()=>spawnNote(icon),600);}}};if(a.readyState<1){a.addEventListener('loadedmetadata',start,{once:true});a.preload='auto';}else start();}
function spawnNote(icon){const n=document.createElement('div');n.className='note';n.textContent=Math.random()>.5?'üéµ':'üé∂';n.style.left=(icon.offsetLeft+20)+'px';n.style.top=(icon.offsetTop-10)+'px';stage.appendChild(n);setTimeout(()=>n.remove(),1200);}

/* Playback buttons */
fin.onclick=()=>{if(playing){stopAll();return;}playing=true;startTime=Date.now();fin.textContent='Stop';piano.currentTime=0;piano.play();for(const k in selected){if(k!=='piano')play(k)}};
reset.onclick=()=>{stopAll();for(const k in selected){if(k!=='piano')delete selected[k];}document.querySelectorAll('.in-stage').forEach(el=>el.remove());list.innerHTML='';};
function stopAll(){playing=false;fin.textContent='Finish & Play';for(const k in selected){selected[k].pause();selected[k].currentTime=0}for(const k in timers){clearInterval(timers[k]);delete timers[k]}document.querySelectorAll('.in-stage.playing').forEach(el=>el.classList.remove('playing'))}
/* Reference audio */
const refAud=new Audio('input.wav');let refPlay=false;refBtn.onclick=()=>{if(refPlay){refAud.pause();refBtn.textContent='‚ñ∂Ô∏è Reference';refPlay=false}else{refAud.currentTime=0;refAud.play();refBtn.textContent='‚è∏ Reference';refPlay=true}};refAud.onended=()=>{refBtn.textContent='‚ñ∂Ô∏è Reference';refPlay=false};
</script>
</body>
</html>
